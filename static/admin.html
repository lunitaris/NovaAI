<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>🧠 Admin Nova</title>
  <link rel="stylesheet" href="/stylesAdmin.css">
</head>
<body>
  <nav>
    <h2>🛠️ Admin Nova</h2>
    <ul>
      <li onclick="showSection('synthetic')">🧠 Mémoire Synthétique</li>
      <li onclick="showSection('semantic')">📚 Mémoire Sémantique</li>
      <li onclick="showSection('settings')">⚙️ Paramètres</li>
    </ul>
  </nav>
  <main>

    <section id="synthetic" class="section active">
      <h2>Mémoire Synthétique</h2>
      <p>Résumés thématiques condensés utilisés pour contextualiser les conversations. Nova les génère automatiquement à partir de l'historique utilisateur.</p>
      <button id="load-btn" onclick="loadSyntheticMemory()">🔄 Load synthetic memory</button>
      <button onclick="exportSyntheticMemory()">💾 Exporter la mémoire en .json</button>
      <input type="file" id="import-file" accept=".json">
      <button onclick="importSyntheticMemory()">📂 Importer .json</button>
      <div id="synthetic-list"></div>
    </section>

    <section id="semantic" class="section">
      <h2>Mémoire Sémantique</h2>
      <p>Stockage vectoriel via FAISS pour retrouver des souvenirs similaires à une idée exprimée.</p>
      <p><em>À venir</em></p>
    </section>
    <section id="settings" class="section">
      <h2>Paramètres</h2>
      <p>Configuration avancée de la mémoire, règles de rétention, seuil d'importance, etc. (à venir)</p>
    </section>
  </main>

  <script>
    function showSection(id) {
      document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }


    function exportSyntheticMemory() {
        fetch("/memory/synthetic/export")
            .then(res => res.json())
            .then(data => {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = "nova_synthetic_memory.json";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            });
    }


    function importSyntheticMemory() {
        const fileInput = document.getElementById("import-file");
        const file = fileInput.files[0];
        if (!file) {
            alert("Veuillez choisir un fichier JSON");
            return;
        }

        const formData = new FormData();
        formData.append("file", file);

        fetch("/memory/synthetic/import", {
            method: "POST",
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === "ok") {
            alert("Import réussi !");
            loadSyntheticMemory();
            } else {
            alert("Erreur : " + data.reason);
            }
        });
    }



    async function loadSyntheticMemory() {
      const res = await fetch("/memory/synthetic");
      const data = await res.json();
      const container = document.getElementById("synthetic-list");
      container.innerHTML = "";

      data.summaries.forEach(summary => {
        const [id, content, timestamp, theme, importance] = [summary.id, summary.summary, summary.timestamp, summary.theme, summary.importance];

        const div = document.createElement("div");
        div.className = "summary-block";
        div.innerHTML = `
          <strong>ID:</strong> ${id}<br>
          <strong>Résumé:</strong> ${content}<br>
          <strong>Date:</strong> ${timestamp}<br>
          <label><strong>Thème:</strong>
            <input type="text" value="${theme}" onchange="updateField('${id}', 'theme', this.value)" />
          </label><br>
          <label><strong>Importance:</strong>
            <select onchange="updateField('${id}', 'importance', this.value)">
              ${[...Array(11).keys()].map(i => `<option value="${i}" ${i == importance ? "selected" : ""}>${i}</option>`).join('')}
            </select>
          </label><br>
          <button onclick="deleteSummary('${id}')">🗑️ Supprimer</button>
        `;
        container.appendChild(div);
      });
    }

    async function deleteSummary(id) {
      await fetch(`/memory/synthetic/${id}`, { method: "DELETE" });
      loadSyntheticMemory();
    }

    async function updateField(id, field, value) {
      await fetch(`/memory/synthetic/${id}`, {
        method: "PATCH",
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ field, value })
      });
    }

    window.onload = loadSyntheticMemory;
  </script>
</body>
</html>